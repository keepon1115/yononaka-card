<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ§˜æ€§ã‚’ç…§ã‚‰ã™ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ  - ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSSã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥ã—ã¾ã™ã€‚å…ƒã®CSSã‚’ãã®ã¾ã¾ãŠä½¿ã„ãã ã•ã„ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: #f0f4f8;
            color: #333;
            min-height: 100vh;
            display: flex;
        }
        .main-container {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .sidebar {
            width: 300px;
            background: #fff;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        .game-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
        }
        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .player-setup-section {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .player-input-group {
            margin-bottom: 15px;
        }
        .player-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #2196F3;
        }
        .btn-secondary:hover {
            background: #1976D2;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 0;
        }
        .topic-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .player-area {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .hand-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 100;
        }
        .reaction-cards {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        .reaction-card {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            min-width: 120px;
            text-align: center;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .reaction-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }
        .reaction-card.used {
            opacity: 0.5;
            cursor: not-allowed;
            background: #e0e0e0;
        }
        .timer-container {
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            margin: 20px 0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .score-board {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .score-item:last-child {
            border-bottom: none;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
            z-index: 2000;
            max-width: 300px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.reaction-received {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 18px;
            padding: 20px 25px;
        }
        .hidden {
            display: none !important;
        }
        .answer-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }
        .like-button-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 1050;
        }
        .like-button {
            background: #FF69B4;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .like-button:hover {
            background: #FF1493;
            transform: scale(1.1);
        }
        .like-button:active {
            transform: scale(0.95);
        }
        .heart-animation {
            position: fixed;
            font-size: 30px;
            color: #FF69B4;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 2001;
        }
        @keyframes floatUp {
            0% { 
                transform: translateY(0) scale(1) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(-100px) scale(1.5) rotate(15deg); 
                opacity: 0; 
            }
        }
        .roulette-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        .roulette-wheel {
            width: 300px;
            height: 80px;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            background: #fff;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .roulette-strip {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            transition: transform 3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .roulette-item {
            width: 300px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-right: 1px solid #ddd;
        }
        .roulette-pointer {
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 20px solid #4CAF50;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
        }
        .catch-ball-chat-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        .chat-message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .chat-message strong {
            color: #007bff;
        }
        .chat-input-area {
            display: flex;
            margin-top: 10px;
        }
        .chat-input-area input {
            flex-grow: 1;
            margin-right: 10px;
        }
        .round-info {
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
        }
        .final-results {
            padding: 20px;
        }
        .winner-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .winner-section h3 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .winner-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .score-details {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .score-details h4 {
            margin-bottom: 15px;
            color: #333;
        }
        .detail-item {
            padding: 10px;
            margin: 5px 0;
            background: #fff;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .reaction-message-highlight {
            color: #ff69b4;
            font-weight: 700;
            font-size: 20px;
        }
        .turn-indicator {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                order: 2;
            }
            .main-container {
                order: 1;
                padding-bottom: 150px;
            }
            .hand-area {
                padding: 10px;
            }
            .reaction-card {
                min-width: 100px;
                font-size: 14px;
            }
            .like-button-container {
                bottom: 120px;
            }
            .roulette-wheel {
                width: 250px;
            }
            .roulette-item {
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="game-title">å¤šæ§˜æ€§ã‚’ç…§ã‚‰ã™ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </h1>
        
        <div class="player-setup-section" id="playerSetupSection">
            <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š</h2>
            <div class="player-input-group">
                <label for="playerCount">ãƒ—ãƒ¬ã‚¤äººæ•° (2ã€œ4äºº):</label>
                <input type="number" id="playerCount" class="input-field" min="2" max="4" value="2" onchange="updatePlayerNameInputs()">
            </div>
            <div id="playerNameInputsContainer">
                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åå…¥åŠ›æ¬„ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <button class="btn" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <div class="game-area hidden" id="gameArea">
            <div class="round-info" id="roundInfo">ãƒ©ã‚¦ãƒ³ãƒ‰ 1 / 3</div>
            <div class="turn-indicator" id="turnIndicator"></div>
            
            <div class="topic-card" id="topicCard">
                <p id="topicText">ãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼ãŒãŠé¡Œã‚’å¼•ãã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                <button class="btn hidden" id="drawTopicBtn" onclick="drawTopic()">ãŠé¡Œã‚’å¼•ã</button>
            </div>
            
            <div class="timer-container hidden" id="timerContainer">
                <div id="timerText">0:00</div>
            </div>
            
            <div class="player-area" id="playerArea">
                <h3>å›ç­”çŠ¶æ³</h3>
                <div id="answerStatus"></div>
            </div>

            <div class="hidden" id="presentationArea">
                <button class="btn hidden" id="startPresentBtn" onclick="startPresentation()">ç™ºè¡¨ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
                <div id="presentationContent"></div>
                
                <div id="catchBallTimeContainer" class="hidden">
                    <h3>ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚¿ã‚¤ãƒ </h3>
                    <div id="catchBallTimer" style="font-size:24px; text-align:center; margin:10px 0;">2:00</div>
                    <div class="catch-ball-chat-container" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" class="input-field" placeholder="ãƒ¡ãƒ¢ã‚„è³ªå•ã‚’å…¥åŠ›..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-secondary" onclick="sendChatMessage()">ãƒ¡ãƒ¢é€ä¿¡</button>
                    </div>
                    <button class="btn" id="skipCatchBallBtn" onclick="skipCatchBall()">ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã‚’çµ‚äº†</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h2>ã‚²ãƒ¼ãƒ æƒ…å ±</h2>
        <div id="gameInfo"></div>
        <h2>ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</h2>
        <div class="score-board" id="scoreBoard"></div>
    </div>

    <div class="hand-area" id="handArea">
        <div id="handContent"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="like-button-container hidden" id="likeButtonContainer">
        <button class="like-button" onclick="triggerHeartAnimation(event)">â¤ï¸</button>
    </div>

    <script> // type="module" ã¯Firebaseãªã—ã§ã¯ä¸è¦ãªå ´åˆãŒå¤šã„ã§ã™ãŒã€æ§‹æˆã«ã‚ˆã£ã¦ã¯æ®‹ã—ã¦ã‚‚OK
        // Firebaseé–¢é€£ã®importã¯å‰Šé™¤

        const triggerCards = [
            "ã“ã®ä¸–ã«ã¾ã ãªã„ã€‡ã€‡ã¯ï¼Ÿ", "ã ã‚‰ã—ãªã„ã€‡ã€‡ã¯ï¼Ÿ", "ä»Šç¤¾ä¼šã«å¿…è¦ãªã€‡ã€‡ã¯ï¼Ÿ", "ã‚ã‚Šãã†ã§ãªã„ã€‡ã€‡ã¯ï¼Ÿ",
            "æ˜æ—¥ã®ã€‡ã€‡ã¯ï¼Ÿ", "æˆ¦å›½æ™‚ä»£ã®ã€‡ã€‡ã¯ï¼Ÿ", "100å¹´å¾Œã®ã€‡ã€‡ã¯ï¼Ÿ", "å‹é”ã«ãªã‚ŠãŸããªã„ã€‡ã€‡ã¯ï¼Ÿ",
            "æ€ã‚ãšã€‡ã€‡ã—ã¦ã—ã¾ã†ã“ã¨ã¯ï¼Ÿ", "ã¡ã‚‡ã£ã¨æ€–ã„ã€‡ã€‡ã¯ï¼Ÿ", "ã¿ã‚“ãªãŒæ°—ã¥ã„ã¦ã„ãªã„ã€‡ã€‡ã¯ï¼Ÿ",
            "å¤¢ã§ã‚‚è¦‹ãªã„ã€‡ã€‡ã¯ï¼Ÿ", "ä»Šã®æ™‚ä»£ã ã‹ã‚‰ã“ãã®ã€‡ã€‡ã¯ï¼Ÿ", "ç„¡äººå³¶ã ã‹ã‚‰ã“ãã®ã€‡ã€‡ã¯ï¼Ÿ"
        ];

        const wordCards = [
            "æ„Ÿæƒ…","å­£ç¯€","é£Ÿã¹ç‰©","ä¹—ã‚Šç‰©", "æœ","éŠã³","å ´æ‰€","äººç‰©",
            "è‰²","å‹•ç‰©","é“å…·","éŸ³æ¥½"
        ];

        const baseReactionCardTexts = [
            "ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼", "å®Ÿç”¨çš„ï¼", "ã³ã£ãã‚Šï¼", "æ„Ÿå‹•çš„ï¼", "ã‚ã‹ã‚Šã‚„ã™ã„ã­",
            "ãŠã‚‚ã—ã‚ã„ï¼", "ã‚ãŸã‚‰ã—ã„ï¼", "æ´»æ°—ãŒã‚ã‚‹ã­", "æŒ‘æˆ¦çš„ï¼", "ã‚„ã¾ã¨ãªã§ã—ã“ã ã­",
            "ãŠã—ã‚ƒã‚Œã ã­", "æ¸©æ•…çŸ¥æ–°ã ã­", "ä½å§¿å‹¢ã ã­", "ã›ã‚„ã­", "ã—ã¿ã‚‹ã­",
            "ã†ã¾ã‚ŒãŸã­", "ãªã‚‹ã»ã©", "ãã‚Œãã‚Œ", "ã‚„ã‚‰ã‚ŒãŸï¼", "ã†ã²ã‚‡ãƒ¼ï¼"
        ];

        let gameState = { // Firebaseã®gameStateã®ä»£ã‚ã‚Šã«ãƒ­ãƒ¼ã‚«ãƒ«ã§ç®¡ç†
            phase: 'setup', // 'setup', 'waiting', 'answering', 'presentation', 'catchball', 'reaction', 'roundEnd', 'gameEnd'
            currentRound: 1,
            maxRounds: 3,
            currentTopic: '',
            topicMakerIndex: 0, // ãŠé¡Œã‚’æ±ºå®šã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            currentPlayerIndex: 0, // ç¾åœ¨æ“ä½œä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå›ç­”ã€ç™ºè¡¨ãªã©ï¼‰
            presenterIndex: 0, // ç¾åœ¨ç™ºè¡¨ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            reactionPlayerIndex: 0, // ç¾åœ¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            timer: 0,
            doublePointPlayerIndex: -1, // -1ãªã‚‰è©²å½“è€…ãªã—
            answers: {}, // { playerIndex: { text: "answer", playerName: "name" } }
            presentationOrder: [], // ç™ºè¡¨é † (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é…åˆ—)
            currentPresentationOrderIndex: 0, // presentationOrderã®ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            catchBallTimer: 0,
            chatLog: [], // { playerName: "name", message: "text" }
            reactionDetails: [], // { fromPlayerIndex, toPlayerIndex, text, points, round }
            usedReactionCardIndexes: {} // { playerIndex: [used_card_indices] }
        };

        let players = []; // [{ name: "Player1", score: 0, reactionsSent: 0, id: 0 }, ...]

        let timerInterval = null;
        let catchBallTimerInterval = null;
        
        // UIè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (DOMContentLoadedå¾Œãªã©)
        let ui = {};

        document.addEventListener('DOMContentLoaded', () => {
            ui = {
                playerSetupSection: document.getElementById('playerSetupSection'),
                gameArea: document.getElementById('gameArea'),
                roundInfo: document.getElementById('roundInfo'),
                turnIndicator: document.getElementById('turnIndicator'),
                topicCard: document.getElementById('topicCard'),
                topicText: document.getElementById('topicText'),
                drawTopicBtn: document.getElementById('drawTopicBtn'),
                timerContainer: document.getElementById('timerContainer'),
                timerText: document.getElementById('timerText'),
                playerArea: document.getElementById('playerArea'),
                answerStatus: document.getElementById('answerStatus'),
                presentationArea: document.getElementById('presentationArea'),
                startPresentBtn: document.getElementById('startPresentBtn'),
                presentationContent: document.getElementById('presentationContent'),
                catchBallTimeContainer: document.getElementById('catchBallTimeContainer'),
                catchBallTimer: document.getElementById('catchBallTimer'),
                chatMessages: document.getElementById('chatMessages'),
                chatInput: document.getElementById('chatInput'),
                skipCatchBallBtn: document.getElementById('skipCatchBallBtn'),
                gameInfo: document.getElementById('gameInfo'),
                scoreBoard: document.getElementById('scoreBoard'),
                handArea: document.getElementById('handArea'),
                handContent: document.getElementById('handContent'),
                modal: document.getElementById('modal'),
                modalContent: document.getElementById('modalContent'),
                toast: document.getElementById('toast'),
                likeButtonContainer: document.getElementById('likeButtonContainer'),
                playerCountInput: document.getElementById('playerCount'),
                playerNameInputsContainer: document.getElementById('playerNameInputsContainer')
            };
            updatePlayerNameInputs(); // åˆæœŸè¡¨ç¤º
            ui.playerCountInput.focus();
        });


        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function showToast(message, isReaction = false) {
            ui.toast.textContent = message;
            ui.toast.classList.add('show');
            if (isReaction) {
                ui.toast.classList.add('reaction-received');
            }
            setTimeout(() => {
                ui.toast.classList.remove('show', 'reaction-received');
            }, isReaction ? 4000 : 3000);
        }

        function updatePlayerNameInputs() {
            const count = parseInt(ui.playerCountInput.value);
            ui.playerNameInputsContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'player-input-group';
                inputGroup.innerHTML = `
                    <label for="playerName${i}">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i + 1} ã®åå‰:</label>
                    <input type="text" id="playerName${i}" class="input-field" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}">
                `;
                ui.playerNameInputsContainer.appendChild(inputGroup);
            }
        }

        window.startGame = function() {
            const count = parseInt(ui.playerCountInput.value);
            players = [];
            for (let i = 0; i < count; i++) {
                const nameInput = document.getElementById(`playerName${i}`);
                if (!nameInput || !nameInput.value.trim()) {
                    showToast(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${i + 1} ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
                    return;
                }
                players.push({ 
                    id: i, 
                    name: nameInput.value.trim(), 
                    score: 0, 
                    reactionsSent: 0 
                });
            }

            if (players.length < 2) {
                showToast('æœ€ä½2äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã§ã™');
                return;
            }

            ui.playerSetupSection.classList.add('hidden');
            ui.gameArea.classList.remove('hidden');
            ui.handArea.style.display = 'block';
            ui.likeButtonContainer.classList.remove('hidden');
            
            gameState.phase = 'waiting';
            gameState.topicMakerIndex = 0; //æœ€åˆã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼0ãŒãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼
            gameState.currentPlayerIndex = gameState.topicMakerIndex; 
            updateGameDisplay();
        }
        
        function updateGameDisplay() {
            // ãƒ©ã‚¦ãƒ³ãƒ‰æƒ…å ±
            ui.roundInfo.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${gameState.currentRound} / ${gameState.maxRounds}`;
            
            // ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
            if (players.length > 0 && gameState.currentPlayerIndex < players.length) {
                 let turnText = `${players[gameState.currentPlayerIndex].name}ã•ã‚“ã®ã‚¿ãƒ¼ãƒ³`;
                 if (gameState.phase === 'answering' && gameState.topicMakerIndex === gameState.currentPlayerIndex) {
                    turnText += ` (ãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼)`;
                 } else if (gameState.phase === 'presentation') {
                    turnText = `${players[gameState.presenterIndex].name}ã•ã‚“ã®ç™ºè¡¨`;
                 } else if (gameState.phase === 'catchball') {
                    turnText = `${players[gameState.presenterIndex].name}ã•ã‚“ã¸ã®ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚¿ã‚¤ãƒ `;
                 } else if (gameState.phase === 'reaction') {
                    turnText = `${players[gameState.presenterIndex].name}ã•ã‚“ã¸ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (${players[gameState.reactionPlayerIndex].name}ã•ã‚“ãŒå…¥åŠ›ä¸­)`;
                 }
                 ui.turnIndicator.textContent = turnText;
            } else {
                ui.turnIndicator.textContent = '';
            }

            // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰
            updateScoreBoard();
            // ã‚²ãƒ¼ãƒ æƒ…å ± (ã‚µã‚¤ãƒ‰ãƒãƒ¼)
            updateGameInfo();


            // ãŠé¡Œã‚«ãƒ¼ãƒ‰ã¨ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            ui.drawTopicBtn.classList.add('hidden');
            ui.startPresentBtn.classList.add('hidden'); //ç™ºè¡¨ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            ui.presentationArea.classList.add('hidden');
            ui.catchBallTimeContainer.classList.add('hidden');
            ui.handContent.innerHTML = ''; // æ‰‹æœ­ã‚¨ãƒªã‚¢ã‚¯ãƒªã‚¢

            if (gameState.phase === 'waiting') {
                ui.topicText.textContent = `${players[gameState.topicMakerIndex].name}ã•ã‚“ãŒãŠé¡Œã‚’å¼•ãã®ã‚’å¾…ã£ã¦ã„ã¾ã™...`;
                if (gameState.currentPlayerIndex === gameState.topicMakerIndex) {
                    ui.drawTopicBtn.classList.remove('hidden');
                }
                ui.timerContainer.classList.add('hidden');
                ui.playerArea.classList.add('hidden'); //å›ç­”çŠ¶æ³ã¯ã¾ã 
            } else if (gameState.phase === 'answering') {
                ui.topicText.textContent = gameState.currentTopic;
                ui.timerContainer.classList.remove('hidden');
                updateTimer(gameState.timer);
                ui.playerArea.classList.remove('hidden');
                showAnswerInput(); // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›æ¬„
                updateAnswerStatus();
            } else if (gameState.phase === 'presentation') {
                ui.topicText.textContent = gameState.currentTopic;
                ui.presentationArea.classList.remove('hidden');
                showPresentation();
            } else if (gameState.phase === 'catchball') {
                ui.topicText.textContent = gameState.currentTopic;
                ui.presentationArea.classList.remove('hidden'); //ç™ºè¡¨å†…å®¹ã‚‚è¡¨ç¤ºã—ãŸã¾ã¾
                ui.presentationContent.classList.remove('hidden'); 
                ui.catchBallTimeContainer.classList.remove('hidden');
                showCatchBallTime();
            } else if (gameState.phase === 'reaction') {
                ui.topicText.textContent = gameState.currentTopic;
                ui.presentationArea.classList.remove('hidden'); //ç™ºè¡¨å†…å®¹ã‚‚è¡¨ç¤ºã—ãŸã¾ã¾
                ui.presentationContent.classList.remove('hidden');
                showReactionSelection();
            } else if (gameState.phase === 'gameEnd') {
                showFinalResults();
            }
        }
        
        function updateGameInfo() {
            ui.gameInfo.innerHTML = `
                <p>ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰: ${gameState.currentRound} / ${gameState.maxRounds}</p>
                <p>å‚åŠ è€…: ${players.length}äºº</p>
            `;
        }

        function updateScoreBoard() {
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            ui.scoreBoard.innerHTML = sortedPlayers.map(player => `
                <div class="score-item">
                    <span>${player.name}</span>
                    <span>${player.score}ç‚¹</span>
                </div>
            `).join('');
        }
        
        window.drawTopic = function() {
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼ã‹ç¢ºèª
            if (gameState.currentPlayerIndex !== gameState.topicMakerIndex) {
                showToast("ã‚ãªãŸã¯ãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            const trigger = shuffle(triggerCards)[0];
            const modalContent = `
                <h2>${trigger}</h2>
                <p>ã€‡ã€‡ã®éƒ¨åˆ†ã‚’æ±ºã‚ã¦ãã ã•ã„</p>
                <button class="btn" onclick="selectWordMethod('self', '${trigger}')">è‡ªåˆ†ã§å…¥åŠ›ï¼ˆå¾—ç‚¹2å€ï¼‰</button>
                <button class="btn btn-secondary" onclick="selectWordMethod('card', '${trigger}')">ãƒ¯ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸ã¶</button>
            `;
            showModal(modalContent);
        };

        window.selectWordMethod = function(method, trigger) {
            if (method === 'self') {
                const modalContent = `
                    <h2>ã€‡ã€‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
                    <input type="text" id="customWord" class="input-field" autofocus>
                    <button class="btn" onclick="setTopic('${trigger}', document.getElementById('customWord').value, true)">æ±ºå®š</button>
                `;
                showModal(modalContent);
                setTimeout(() => document.getElementById('customWord').focus(), 100);
            } else {
                showRouletteModal(trigger);
            }
        };
        
        function showRouletteModal(trigger) {
            const shuffledWords = [];
            for (let i = 0; i < 5; i++) { // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®è¦‹æ „ãˆã®ãŸã‚ã«è¤‡æ•°å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é€£çµ
                shuffledWords.push(...shuffle(wordCards));
            }
            
            const modalContent = `
                <h2>ãƒ¯ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>
                <div class="roulette-container">
                    <div class="roulette-wheel">
                        <div class="roulette-pointer"></div>
                        <div class="roulette-strip" id="rouletteStrip">
                            ${shuffledWords.map(word => `<div class="roulette-item">${word}</div>`).join('')}
                        </div>
                    </div>
                    <button class="btn" onclick="startRoulette('${trigger}')">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
                </div>
            `;
            showModal(modalContent);
        }

        window.startRoulette = function(trigger) {
            const strip = document.getElementById('rouletteStrip');
            if (!strip) return;
            const totalItemsInVisualStrip = strip.children.length;
            const itemWidth = 300; // .roulette-item ã®å¹…ã¨åˆã‚ã›ã‚‹
            
            // wordCards ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã³ã€ãã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å…ƒã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®åœæ­¢ä½ç½®ã‚’æ±ºã‚ã‚‹
            const actualWordIndex = Math.floor(Math.random() * wordCards.length);
            // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¹ãƒˆãƒªãƒƒãƒ—å†…ã§ã€é¸ã°ã‚ŒãŸãƒ¯ãƒ¼ãƒ‰ãŒè¤‡æ•°å›ç¾ã‚Œã‚‹ã†ã¡ã®ã€ã‚ã‚‹ç¨‹åº¦ã®å›è»¢ã‚’è¦‹ã›ã‚‹ãŸã‚ã®ä½ç½®
            // ä¾‹ãˆã°ã€wordCards.length ã®2å€ä»¥é™ã®ä½ç½®ã§åœæ­¢ã•ã›ã‚‹
            const targetStopIndexInStrip = actualWordIndex + (wordCards.length * (Math.floor(Math.random() * 2) + 2));
            
            const finalPosition = -(targetStopIndexInStrip * itemWidth) + (itemWidth / 2); // ä¸­å¤®ã«æ­¢ã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ï¼ˆroulette-wheelã®å¹…ã¨itemã®å¹…ãŒåŒã˜å ´åˆï¼‰
                                                                                       // ãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãƒã‚¤ãƒ³ã‚¿ä½ç½®ã«åˆã‚ã›ã‚‹
            
            strip.style.transform = `translateX(${finalPosition}px)`;
            
            setTimeout(() => {
                const selectedWord = wordCards[actualWordIndex];
                setTopic(trigger, selectedWord, false);
            }, 3000); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“
        };


        window.setTopic = function(trigger, word, isDouble) {
            if (!word || !word.trim()) {
                showToast("æœ‰åŠ¹ãªãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            gameState.currentTopic = trigger.replace('ã€‡ã€‡', word.trim());
            gameState.doublePointPlayerIndex = isDouble ? gameState.topicMakerIndex : -1;
            gameState.phase = 'answering';
            gameState.timer = 120; // 2åˆ†
            gameState.answers = {}; // å›ç­”ãƒªã‚»ãƒƒãƒˆ
            gameState.currentPlayerIndex = 0; // å›ç­”ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼0ã‹ã‚‰é †ç•ªã«
            
            hideModal();
            updateGameDisplay();
            startLocalTimer();
        };

        function startLocalTimer() {
            if (timerInterval) clearInterval(timerInterval);
            updateTimer(gameState.timer); // åˆæœŸè¡¨ç¤º
            timerInterval = setInterval(() => {
                gameState.timer--;
                updateTimer(gameState.timer);
                if (gameState.timer <= 0) {
                    clearInterval(timerInterval);
                    handleAnsweringTimeUp();
                }
            }, 1000);
        }
        
        function updateTimer(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            ui.timerText.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function handleAnsweringTimeUp() {
            showToast("å›ç­”æ™‚é–“çµ‚äº†ï¼");
            // ã¾ã å›ç­”ã—ã¦ã„ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã‚Œã°ã€ãã®äººã®ã‚¿ãƒ¼ãƒ³ã¯çµ‚äº†
            // å…¨å“¡ã®å›ç­”ãŒæƒã£ã¦ã„ãªãã¦ã‚‚ç™ºè¡¨ãƒ•ã‚§ãƒ¼ã‚ºã¸
            if (Object.keys(gameState.answers).length < players.length) {
                showToast("æœªå›ç­”ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã™ã€‚ç™ºè¡¨ã¯å›ç­”è€…ã®ã¿ã§è¡Œã„ã¾ã™ã€‚");
            }
            preparePresentation();
        }

        function showAnswerInput() {
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã¾ã å›ç­”ã—ã¦ã„ãªã‘ã‚Œã°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
            if (!gameState.answers[gameState.currentPlayerIndex]) {
                ui.handContent.innerHTML = `
                    <h3>${players[gameState.currentPlayerIndex].name}ã•ã‚“ã®å›ç­”</h3>
                    <input type="text" id="myAnswer" class="input-field" placeholder="å›ç­”ã‚’å…¥åŠ›">
                    <button class="btn" onclick="submitAnswer()">é€ä¿¡ã—ã¦æ¬¡ã®äººã¸</button>
                `;
                setTimeout(()=> document.getElementById('myAnswer')?.focus(), 0);
            } else {
                // æ—¢ã«å›ç­”æ¸ˆã¿ãªã‚‰ã€æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ä¿ƒã™ã‹ã€å…¨å“¡å›ç­”æ¸ˆã¿ãªã‚‰ç™ºè¡¨æº–å‚™ã¸
                ui.handContent.innerHTML = `<p>${players[gameState.currentPlayerIndex].name}ã•ã‚“ã¯å›ç­”æ¸ˆã¿ã§ã™ã€‚æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã©ã†ãã€‚</p>`;
                // ã“ã“ã§è‡ªå‹•ã§æ¬¡ã«é€²ã‚ã‚‹ã‹ã€ãƒœã‚¿ãƒ³ã‚’å‡ºã™ã‹ãªã©æ¤œè¨
            }
        }

        window.submitAnswer = function() {
            const answerInput = document.getElementById('myAnswer');
            if (!answerInput) return;
            const answerText = answerInput.value.trim();
            if (!answerText) {
                showToast("å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            gameState.answers[gameState.currentPlayerIndex] = {
                text: answerText,
                playerName: players[gameState.currentPlayerIndex].name
            };
            
            showToast(`${players[gameState.currentPlayerIndex].name}ã•ã‚“ã®å›ç­”ã‚’é€ä¿¡ã—ã¾ã—ãŸ`);
            updateAnswerStatus();

            // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
            gameState.currentPlayerIndex++;
            if (gameState.currentPlayerIndex >= players.length) {
                // å…¨å“¡ã®ã‚¿ãƒ¼ãƒ³ãŒä¸€å·¡
                clearInterval(timerInterval); // å…¨å“¡å›ç­”ã—ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                preparePresentation();
            } else {
                // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã¸
                updateGameDisplay();
                 // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å…¥åŠ›ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                showToast(`${players[gameState.currentPlayerIndex].name}ã•ã‚“ã®ç•ªã§ã™ã€‚ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚`, true);
            }
        };
        
        function updateAnswerStatus() {
            const answeredCount = Object.keys(gameState.answers).length;
            ui.answerStatus.innerHTML = `<p>å›ç­”æ¸ˆã¿: ${answeredCount} / ${players.length} äºº</p>`;
        }

        function preparePresentation() {
            const answeredPlayerIndices = Object.keys(gameState.answers).map(idx => parseInt(idx));
            if (answeredPlayerIndices.length === 0) {
                showToast("å›ç­”è€…ãŒèª°ã‚‚ã„ã¾ã›ã‚“ã€‚ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¯çµ‚äº†ã—ã¾ã™ã€‚");
                handleRoundEnd();
                return;
            }
            gameState.presentationOrder = shuffle(answeredPlayerIndices);
            gameState.currentPresentationOrderIndex = 0;
            gameState.phase = 'presentation';
            if (gameState.presentationOrder.length > 0) {
                gameState.presenterIndex = gameState.presentationOrder[gameState.currentPresentationOrderIndex];
                gameState.currentPlayerIndex = gameState.presenterIndex; //ç™ºè¡¨è€…ãŒæ“ä½œ
            }
            updateGameDisplay();
        }
        
        // startPresentationã¯HTMLã‹ã‚‰ã¯å‘¼ã°ã‚Œãšã€preparePresentationã‹ã‚‰ç›´æ¥showPresentationãŒå‘¼ã°ã‚Œã‚‹æƒ³å®š
        // ã‚‚ã—ç™ºè¡¨é–‹å§‹ãƒœã‚¿ãƒ³ãŒå¿…è¦ãªã‚‰ã€preparePresentationã®æœ€å¾Œã«ãƒœã‚¿ãƒ³è¡¨ç¤ºå‡¦ç†ã‚’è¿½åŠ 
        
        function showPresentation() {
            if (gameState.currentPresentationOrderIndex >= gameState.presentationOrder.length) {
                // å…¨å“¡ã®ç™ºè¡¨ãŒçµ‚äº†
                handleRoundEnd(); // å…¨å“¡ã®ç™ºè¡¨ãŒçµ‚ã‚ã£ãŸã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†å‡¦ç†
                return;
            }
            
            gameState.presenterIndex = gameState.presentationOrder[gameState.currentPresentationOrderIndex];
            const presenterData = gameState.answers[gameState.presenterIndex];

            ui.presentationContent.innerHTML = `
                <div class="answer-display">
                    <h3>${presenterData.playerName}ã®ç™ºè¡¨</h3>
                    <p style="font-size: 28px; margin: 20px 0; font-weight: 700;">${presenterData.text}</p>
                    <p>30ç§’ã§èª¬æ˜ã—ã¦ãã ã•ã„ï¼ˆå£é ­ã§ãŠé¡˜ã„ã—ã¾ã™ï¼‰</p>
                </div>
            `;
            ui.presentationContent.classList.remove('hidden');


            // ç™ºè¡¨è€…ã®æ“ä½œã§ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã¸é€²ã‚€ãƒœã‚¿ãƒ³
            ui.startPresentBtn.textContent = 'ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã¸é€²ã‚€'; // ãƒœã‚¿ãƒ³æ–‡è¨€å¤‰æ›´
            ui.startPresentBtn.classList.remove('hidden');
            ui.startPresentBtn.onclick = () => {
                 gameState.phase = 'catchball';
                 gameState.catchBallTimer = 120; // 2åˆ†
                 gameState.chatLog = []; // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ãƒªã‚»ãƒƒãƒˆ
                 updateGameDisplay();
                 startCatchBallLocalTimer();
            };
        }

        function startCatchBallLocalTimer() {
            if (catchBallTimerInterval) clearInterval(catchBallTimerInterval);
            updateCatchBallTimerDisplay(gameState.catchBallTimer);
            catchBallTimerInterval = setInterval(() => {
                gameState.catchBallTimer--;
                updateCatchBallTimerDisplay(gameState.catchBallTimer);
                if (gameState.catchBallTimer <= 0) {
                    clearInterval(catchBallTimerInterval);
                    skipCatchBall(); // æ™‚é–“åˆ‡ã‚Œã§è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—
                }
            }, 1000);
        }
        
        function updateCatchBallTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            ui.catchBallTimer.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function showCatchBallTime() {
            updateCatchBallTimerDisplay(gameState.catchBallTimer);
            updateChatMessages(); //ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºæ›´æ–°
            // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤º (ç™ºè¡¨è€…ã‹èª°ã§ã‚‚ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹æƒ³å®š)
            ui.skipCatchBallBtn.style.display = 'block';
        }

        window.skipCatchBall = function() {
            if (catchBallTimerInterval) clearInterval(catchBallTimerInterval);
            gameState.phase = 'reaction';
            // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ç™ºè¡¨è€…ä»¥å¤–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé †ç•ªã«è¡Œã†
            gameState.reactionPlayerIndex = 0; // æœ€åˆã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            // gameState.currentPlayerIndex ã¯ reactionPlayerIndex ã«åˆã‚ã›ã‚‹
            // ãŸã ã—ã€reactionPlayerIndex ãŒç™ºè¡¨è€…è‡ªèº«ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
            advanceToNextReactionPlayer(); 
            updateGameDisplay();
        };
        
        function advanceToNextReactionPlayer() {
            // ç™ºè¡¨è€…è‡ªèº«ã¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—
            while (gameState.reactionPlayerIndex < players.length && 
                   gameState.reactionPlayerIndex === gameState.presenterIndex) {
                gameState.reactionPlayerIndex++;
            }
            if (gameState.reactionPlayerIndex >= players.length) {
                // å…¨å“¡ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚äº†
                moveToNextPresentationOrEnd();
            } else {
                gameState.currentPlayerIndex = gameState.reactionPlayerIndex; //æ“ä½œè€…ã‚’æ›´æ–°
            }
        }

        window.sendChatMessage = function() {
            const messageText = ui.chatInput.value.trim();
            if (!messageText) return;

            // ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã§ã¯ã€ç¾åœ¨ã®æ“ä½œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç™ºè¡¨è€…ã¾ãŸã¯ä»–ã®äººï¼‰ãŒãƒ¡ãƒ¢ã‚’æ®‹ã›ã‚‹
            const chatterName = players[gameState.currentPlayerIndex]?.name || "ã‚²ã‚¹ãƒˆ";
            gameState.chatLog.push({ playerName: chatterName, message: messageText });
            
            updateChatMessages();
            ui.chatInput.value = '';
            ui.chatInput.focus();
        };
        
        window.handleChatKeyPress = function(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        };

        function updateChatMessages() {
            ui.chatMessages.innerHTML = gameState.chatLog.map(msg => `
                <div class="chat-message">
                    <strong>${msg.playerName}:</strong> ${msg.message}
                </div>
            `).join('');
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
        }
        
        function showReactionSelection() {
             // gameState.reactionPlayerIndex ãŒç¾åœ¨ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            const reactor = players[gameState.reactionPlayerIndex];
            
            // ä½¿ç”¨æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®ç®¡ç†ã‚’åˆæœŸåŒ– (ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨)
            if (!gameState.usedReactionCardIndexes[reactor.id]) {
                gameState.usedReactionCardIndexes[reactor.id] = [];
            }
            const usedIndexes = gameState.usedReactionCardIndexes[reactor.id];

            const availableCards = baseReactionCardTexts.map((text, index) => ({
                text,
                index,
                used: usedIndexes.includes(index)
            }));

            ui.handContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 10px;">
                    <h3 class="reaction-message-highlight">
                        ${reactor.name}ã•ã‚“ã€ç™ºè¡¨è€…ï¼ˆ${players[gameState.presenterIndex].name}ã•ã‚“ï¼‰ã¸<br>
                        ã‚«ãƒ¼ãƒ‰ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹è¨€è‘‰ã‚’èª­ã¿ä¸Šã’ã¦ã€<br>
                        æ°—æŒã¡ã‚’è¾¼ã‚ã¦æ¸¡ã—ã¦ãã ã•ã„ã­ã€‚
                    </h3>
                </div>
                <div class="reaction-cards">
                    ${availableCards.map(card => `
                        <div class="reaction-card ${card.used ? 'used' : ''}" 
                             onclick="${card.used ? '' : `sendReaction(${card.index})`}">
                            <div>${card.text}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 10px;">
                     <button class="btn btn-secondary" onclick="skipReaction()">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—</button>
                </div>
            `;
             // 30ç§’ã‚¿ã‚¤ãƒãƒ¼ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã§ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¤æ–­ã§ã‚‚è‰¯ã„)
             // ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã®ã‚¿ã‚¤ãƒãƒ¼ã¯ä¸€æ—¦çœç•¥
        }
        
        window.skipReaction = function() {
            showToast(`${players[gameState.reactionPlayerIndex].name}ã•ã‚“ã¯ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
            gameState.reactionPlayerIndex++;
            advanceToNextReactionPlayer();
            updateGameDisplay();
        }

        window.sendReaction = function(cardIndex) {
            const reactorIndex = gameState.reactionPlayerIndex;
            const presenter = players[gameState.presenterIndex];
            const reactor = players[reactorIndex];

            const reactionText = baseReactionCardTexts[cardIndex];
            const points = Math.floor(Math.random() * 5) + 1; // 1ã€œ5ç‚¹
            
            const isDouble = gameState.doublePointPlayerIndex === gameState.presenterIndex;
            const finalPoints = points * (isDouble ? 2 : 1);
            
            presenter.score += finalPoints;
            reactor.reactionsSent += 1;
            
            gameState.usedReactionCardIndexes[reactor.id].push(cardIndex);
            
            gameState.reactionDetails.push({
                fromPlayerIndex: reactorIndex,
                toPlayerIndex: gameState.presenterIndex,
                text: reactionText,
                points: finalPoints,
                round: gameState.currentRound
            });

            showToast(`${reactor.name}ã•ã‚“ãŒ${presenter.name}ã•ã‚“ã«ã€Œ${reactionText}ã€(${finalPoints}ç‚¹) ã‚’é€ã‚Šã¾ã—ãŸï¼`, true);
            
            // æ¬¡ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
            gameState.reactionPlayerIndex++;
            advanceToNextReactionPlayer();
            updateGameDisplay();
        };

        function moveToNextPresentationOrEnd() {
            gameState.currentPresentationOrderIndex++;
            if (gameState.currentPresentationOrderIndex >= gameState.presentationOrder.length) {
                // å…¨å“¡ã®ç™ºè¡¨ã¨ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒçµ‚äº†
                handleRoundEnd();
            } else {
                // æ¬¡ã®ç™ºè¡¨è€…ã¸
                gameState.presenterIndex = gameState.presentationOrder[gameState.currentPresentationOrderIndex];
                gameState.currentPlayerIndex = gameState.presenterIndex;
                gameState.phase = 'presentation';
                 // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                gameState.reactionPlayerIndex = 0;
                advanceToNextReactionPlayer(); // reactionPlayerIndexã‚’é©åˆ‡ã«è¨­å®š
            }
            updateGameDisplay();
        }

        function handleRoundEnd() {
            showToast(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${gameState.currentRound} çµ‚äº†ï¼`);
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ä½¿ç”¨æ¸ˆã¿ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            gameState.usedReactionCardIndexes = {};

            if (gameState.currentRound >= gameState.maxRounds) {
                gameState.phase = 'gameEnd';
            } else {
                gameState.currentRound++;
                gameState.phase = 'waiting';
                // æ¬¡ã®ãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼ (å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®ãŠé¡Œãƒ¡ãƒ¼ã‚«ãƒ¼ã®æ¬¡ã®äºº)
                gameState.topicMakerIndex = (gameState.topicMakerIndex + 1) % players.length;
                gameState.currentPlayerIndex = gameState.topicMakerIndex;
                gameState.answers = {};
                gameState.presentationOrder = [];
                gameState.currentPresentationOrderIndex = 0;
                gameState.doublePointPlayerIndex = -1;
                gameState.chatLog = [];
            }
            updateGameDisplay();
        }

        function showFinalResults() {
            let waiwaiKing = { name: '', score: -1 };
            let emotionalDoctor = { name: '', count: -1 };
            
            players.forEach(player => {
                if (player.score > waiwaiKing.score) {
                    waiwaiKing = { name: player.name, score: player.score };
                }
                if (player.reactionsSent > emotionalDoctor.count) {
                    emotionalDoctor = { name: player.name, count: player.reactionsSent };
                }
            });
            
            const playerDetailMap = {};
            players.forEach(p => {
                playerDetailMap[p.id] = { name: p.name, reactionsReceived: [] };
            });

            gameState.reactionDetails.forEach(detail => {
                if (playerDetailMap[detail.toPlayerIndex]) {
                     playerDetailMap[detail.toPlayerIndex].reactionsReceived.push({
                        fromName: players[detail.fromPlayerIndex].name,
                        text: detail.text,
                        points: detail.points,
                        round: detail.round
                    });
                }
            });
            
            const modalContent = `
                <div class="final-results">
                    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ‰ æœ€çµ‚çµæœç™ºè¡¨ ğŸ‰</h2>
                    
                    <div class="winner-section">
                        <div class="winner-icon">ğŸ‘‘</div>
                        <h3>ã‚ã„ã‚ã„ã‚­ãƒ³ã‚°</h3>
                        <p style="font-size: 24px;">${waiwaiKing.name || 'è©²å½“è€…ãªã—'}</p>
                        <p style="font-size: 20px;">${waiwaiKing.score > -1 ? waiwaiKing.score + 'ç‚¹' : '-'}</p>
                    </div>
                    
                    <div class="winner-section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="winner-icon">ğŸ“</div>
                        <h3>ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«åšå£«</h3>
                        <p style="font-size: 24px;">${emotionalDoctor.name || 'è©²å½“è€…ãªã—'}</p>
                        <p style="font-size: 20px;">${emotionalDoctor.count > -1 ? emotionalDoctor.count + 'æšã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’è´ˆã‚Šã¾ã—ãŸ' : '-'}</p>
                    </div>
                    
                    <div class="score-details">
                        <h4>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå—ã‘å–ã£ãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…è¨³</h4>
                        ${Object.values(playerDetailMap).map(data => `
                            <div style="margin-bottom: 20px;">
                                <h5 style="color: #333; margin-bottom: 10px;">${data.name}ã•ã‚“</h5>
                                ${data.reactionsReceived.length > 0 ? data.reactionsReceived.map(r => `
                                    <div class="detail-item">
                                        ãƒ©ã‚¦ãƒ³ãƒ‰${r.round}: ${r.fromName}ã•ã‚“ã‹ã‚‰ã€Œ${r.text}ã€(${r.points}ç‚¹)
                                    </div>
                                `).join('') : '<p>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>'}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="location.reload()">æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹</button>
                    </div>
                </div>
            `;
            showModal(modalContent, false); // é–‰ã˜ã‚‰ã‚Œãªã„ãƒ¢ãƒ¼ãƒ€ãƒ«
        }

        window.triggerHeartAnimation = function(event) {
            const heart = document.createElement('div');
            heart.className = 'heart-animation';
            heart.innerHTML = 'â¤ï¸';
            // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
            heart.style.left = event.clientX - 15 + 'px'; 
            heart.style.top = event.clientY - 15 + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1500);
        };

        function showModal(content, closable = true) {
            ui.modalContent.innerHTML = content;
            ui.modal.style.display = 'flex';
            if (closable) {
                ui.modal.onclick = function(event) {
                    if (event.target === ui.modal) {
                        hideModal();
                    }
                };
            } else {
                ui.modal.onclick = null; // é–‰ã˜ã‚‰ã‚Œãªã„ã‚ˆã†ã«
            }
        }

        function hideModal() {
            ui.modal.style.display = 'none';
        }

    </script>
</body>
</html>